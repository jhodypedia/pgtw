<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PansaGateway Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- FontAwesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- Toastr -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
<!-- Custom CSS -->
<style>
body {
    background: #f8f9fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.navbar {
    background: linear-gradient(45deg, #007bff, #0056b3);
}
.navbar-brand, .navbar-nav .nav-link {
    color: #fff !important;
}
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.card-header {
    border-radius: 12px 12px 0 0 !important;
}
.qr {
    max-width: 200px;
    border: 5px solid #f1f1f1;
    border-radius: 8px;
}
.table {
    font-size: 0.9rem;
}
.btn-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
}
.btn-primary:hover {
    background: linear-gradient(45deg, #0056b3, #003d80);
}
.modal-header {
    background: linear-gradient(45deg, #007bff, #0056b3);
}
.modal-header .modal-title, .modal-header .btn-close {
    color: #fff;
}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold"><i class="fas fa-wallet"></i> PansaGateway</a>
    <div class="d-flex">
      <button class="btn btn-light btn-sm" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>
</nav>

<!-- Main -->
<div class="container py-4">
  <div class="row g-4">
    <!-- Profile Card -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-primary text-white"><i class="fas fa-user-circle"></i> Profile</div>
        <div class="card-body">
          <p><strong>Username:</strong> <span id="profileUsername"></span></p>
          <p><strong>Email:</strong> <span id="profileEmail"></span></p>
          <p><strong>Saldo:</strong> Rp <span id="profileSaldo"></span></p>
        </div>
      </div>

      <!-- Create Deposit -->
      <div class="card mt-4">
        <div class="card-header bg-success text-white"><i class="fas fa-plus-circle"></i> Create Deposit</div>
        <div class="card-body">
          <form id="depositForm">
            <div class="mb-3">
              <label>Amount</label>
              <input type="number" id="depositAmount" class="form-control" required>
            </div>
            <button class="btn btn-success w-100" type="submit"><i class="fas fa-qrcode"></i> Generate QRIS</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Deposit & Mutations -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white"><i class="fas fa-list"></i> Deposits</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Expired</th>
              </tr>
            </thead>
            <tbody id="depositTable"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-warning text-dark"><i class="fas fa-history"></i> Mutations</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="mutationTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Struk -->
<div class="modal fade" id="strukModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-receipt"></i> Struk Pembayaran</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <h6 class="fw-bold">Pansa Store</h6>
        <img id="modalQrImage" class="qr mb-3" src="">
        <p><strong>Deposit ID:</strong> <span id="modalDepositId"></span></p>
        <p><strong>Amount:</strong> Rp <span id="modalDepositAmount"></span></p>
        <p><strong>Expired At:</strong> <span id="modalDepositExpired"></span></p>
        <p class="text-muted small">Scan QRIS ini menggunakan aplikasi e-wallet Anda</p>
      </div>
      <div class="modal-footer">
        <button id="downloadStrukBtn" class="btn btn-success"><i class="fas fa-download"></i> Download Struk</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const API_BASE = "http://151.240.0.221:3000/api";
const API_KEY = localStorage.getItem("apiKey");

if (!API_KEY) {
    window.location.href = "index.html";
}

// Load Profile
function loadProfile(){
    $.ajax({
        url: API_BASE + "/profile",
        method: "GET",
        headers: { "x-api-key": API_KEY },
        success: function(res){
            $("#profileUsername").text(res.username);
            $("#profileEmail").text(res.email);
            $("#profileSaldo").text(res.saldo);
        }
    });
}

// Load Deposits
function loadDeposits(){
    $.ajax({
        url: API_BASE + "/deposits",
        method: "GET",
        headers: { "x-api-key": API_KEY },
        success: function(res){
            let html = "";
            res.forEach(d => {
                html += `<tr>
                    <td>${d.deposit_id}</td>
                    <td>Rp ${d.amount}</td>
                    <td>${d.status}</td>
                    <td>${d.expired_at}</td>
                </tr>`;
            });
            $("#depositTable").html(html);
        }
    });
}

// Load Mutations
function loadMutations(){
    $.ajax({
        url: API_BASE + "/mutations",
        method: "GET",
        headers: { "x-api-key": API_KEY },
        success: function(res){
            let html = "";
            res.forEach(m => {
                html += `<tr>
                    <td>${m.created_at}</td>
                    <td>${m.type}</td>
                    <td>Rp ${m.amount}</td>
                </tr>`;
            });
            $("#mutationTable").html(html);
        }
    });
}

// Create Deposit
$("#depositForm").submit(function(e){
    e.preventDefault();
    $.ajax({
        url: API_BASE + "/deposit",
        method: "POST",
        contentType: "application/json",
        headers: { "x-api-key": API_KEY },
        data: JSON.stringify({ amount: $("#depositAmount").val() }),
        success: function(res){
            toastr.success("Deposit created");

            // Isi modal struk
            $("#modalQrImage").attr("src", res.qrImage);
            $("#modalDepositId").text(res.depositId);
            $("#modalDepositAmount").text(res.amount);
            $("#modalDepositExpired").text(res.expiredAt);

            // Tampilkan modal
            new bootstrap.Modal(document.getElementById('strukModal')).show();

            loadDeposits();
        },
        error: function(err){
            toastr.error(err.responseJSON?.error || "Failed to create deposit");
        }
    });
});

// Download struk
$("#downloadStrukBtn").click(function(){
    html2canvas(document.querySelector("#strukModal .modal-body")).then(canvas => {
        let link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = "struk_deposit.png";
        link.click();
    });
});

// Logout
$("#logoutBtn").click(function(){
    localStorage.removeItem("apiKey");
    window.location.href = "index.html";
});

// Init
loadProfile();
loadDeposits();
loadMutations();
</script>
</body>
</html>
